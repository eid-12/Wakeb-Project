name: Full Stack Microservices CI/CD

on:
  push:
    branches: [ "main" ] 

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./client
          file: ./client/dockerfile.bak 
          push: true
          tags: minipcer/mapping-frontend:latest
          build-args: |
            VUE_APP_API_GATEWAY_URL=https://maps.cloudbase.website/api
            VUE_APP_AUTH_API_URL=https://maps.cloudbase.website/api/auth
            
      - name: Build API Gateway
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/api-gateway
          push: true
          tags: minipcer/api-gateway:latest


      - name: Build Auth Service
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/Auth-Service
          push: true
          tags: minipcer/auth-service:latest

      - name: Build User Service
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/User-Service
          push: true
          tags: minipcer/user-service:latest

      - name: Build Search Service
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/Search-Service
          push: true
          tags: minipcer/search-service:latest

      - name: Build Place Service
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/Place-Service
          push: true
          tags: minipcer/place-service:latest

      - name: Build SavedPlace Service
        uses: docker/build-push-action@v4
        with:
          context: ./Backend/SavedPlace-Service
          push: true
          tags: minipcer/savedplace-service:latest
