FROM node:18-bullseye AS build
WORKDIR /app
COPY package*.json ./
# نستخدم install لتحديث الـ lock file تلقائياً
RUN npm install 
COPY . .

# متغيرات البيئة للـ Build
ARG VUE_APP_API_GATEWAY_URL
ARG VUE_APP_AUTH_API_URL
ENV VUE_APP_API_GATEWAY_URL=$VUE_APP_API_GATEWAY_URL
ENV VUE_APP_AUTH_API_URL=$VUE_APP_AUTH_API_URL

RUN npm run build --verbose

# المرحلة النهائية
FROM node:18-bullseye
WORKDIR /app

# نسخ ملفات التعريف أولاً
COPY package*.json ./

# تثبيت جميع المكتبات (بما فيها البروكسي) بشكل صريح
RUN npm install --production

# نسخ ملف الخادم وتأكد من وجوده في نفس المسار
COPY server.js ./

# نسخ ملفات الواجهة المبنيه
COPY --from=build /app/dist ./dist

ENV PORT=3000
ENV NODE_ENV=production
EXPOSE 3000

# تشغيل الخادم
CMD ["node", "server.js"]
