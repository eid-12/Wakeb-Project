# المرحلة الأولى: بناء تطبيق Vue
FROM node:18-bullseye AS build
WORKDIR /app
COPY package*.json ./
# استخدمنا install لتحديث ملف الـ Lock تلقائياً أثناء البناء
RUN npm install 
COPY . .

# حقن المتغيرات (ستكون قيمتها /api و /api/auth كما اتفقنا)
ARG VUE_APP_API_GATEWAY_URL
ARG VUE_APP_AUTH_API_URL
ENV VUE_APP_API_GATEWAY_URL=$VUE_APP_API_GATEWAY_URL
ENV VUE_APP_AUTH_API_URL=$VUE_APP_AUTH_API_URL

RUN npm run build --verbose

# المرحلة الثانية: تشغيل الخادم (البروكسي)
FROM node:18-bullseye
WORKDIR /app
COPY package*.json ./

# التعديل الحاسم: تثبيت مكتبات التشغيل (express و proxy) بشكل مؤكد
RUN npm install --production

# نسخ الملفات المطلوبة للتشغيل
COPY server.js ./server.js
COPY --from=build /app/dist ./dist

# إعدادات البيئة
ENV PORT=3000
ENV NODE_ENV=production
EXPOSE 3000

CMD ["node", "server.js"]
